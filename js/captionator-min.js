/* 
	Captionator 0.1
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/

var captionator={captionify:function(c,e,b){var a=[],d=0;b=b instanceof Object?b:{};if(!HTMLVideoElement){return false}else{if(typeof(document.createElement("video").addtrack)=="function"){return false}}if(!c||c===false||c===undefined||c===null){a=[].slice.call(document.getElementsByTagName("video"),0)}else{if(c instanceof Array){for(d=0;d<c.length;d++){if(typeof(c[d])=="string"){a=a.concat([].slice.call(document.querySelectorAll(c[d]),0))}else{if(c[d].constructor==HTMLVideoElement){a.push(c[d])}}}}else{if(typeof(c)=="string"){a=[].slice.call(document.querySelectorAll(c),0)}else{if(c.constructor==HTMLVideoElement){a.push(c)}}}}if(a.length){for(d=0;d<a.length;d++){captionator.processVideoElement(a[d],e,b)}return true}else{return false}},generateTranscript:function(f,c,g,d){var e=g||navigator.language.split("-")[0];var a;d=d instanceof Object?d:{};if(typeof(f)=="string"){f=document.querySelectorAll(f)[0]}if(typeof(c)=="string"){c=document.querySelectorAll(c)[0]}if(f.constructor==HTMLVideoElement&&typeof(c)=="object"){var b=[].slice.call(f.querySelectorAll("track"),0).filter(function(h){return h.getAttribute("srclang").split("-")[0]==e?true:false})[0].getAttribute("src");captionator.fetchCaptions(b,function(h){for(a=0;a<h.length;a++){c.innerHTML+="<p class='transcriptLine'>"+h[a].html+"</p>"}})}else{return false}},processVideoElement:function(d,f,b){var e=[];var c=f||navigator.language.split("-")[0];b=b instanceof Object?b:{};if(!d.captioned){d.className+=(d.className.length?" ":"")+"captioned";d.captioned=true;if(d.id.length===0){var a="";while(a.length<10){a+=String.fromCharCode(65+Math.floor(Math.random()*26))}d.id="captionator"+a}e=[].slice.call(d.querySelectorAll("track"),0).map(function(g){return{label:g.getAttribute("label"),name:g.getAttribute("label"),src:g.getAttribute("src"),type:(g.getAttribute("type")||"unknown"),language:g.getAttribute("srclang").split("-")[0],kind:(g.getAttribute("kind")||g.getAttribute("role")),role:(g.getAttribute("kind")||g.getAttribute("role")),enabled:(g.getAttribute("enabled")==="true"||g.getAttribute("srclang").split("-")[0]==c?true:false),videoElement:d}});d.tracks=e;d.subtitlesReady=false;d.captionatorOptions=b;e.forEach(function(g,h){if(g.enabled===true){captionator.fetchCaptions(g.src,function(i){g.captionData=i;g.subtitlesReady=true;g.enabled=true})}});d.addEventListener("timeupdate",function(h){var g=h.target;captionator.rebuildCaptions(g)},false)}return d},rebuildCaptions:function(b){var d=b.tracks;var c=b.currentTime;var a=b.captionatorOptions instanceof Object?b.captionatorOptions:{};d.forEach(function(g,f){var k=d[f].captionData;var i=[],h;var n;var m=null;var l="captionator-"+b.id+"-"+d[f].kind+"-"+d[f].language+f;if(g.subtitlesReady&&g.enabled){if(a.container&&!d[f].autogen){if(a.container instanceof Array){if(a.container.length>f&&a.container[f]){m=a.container[f]}}else{m=a.container}}else{m="#"+l}if(typeof(m)==="string"){m=document.querySelectorAll(m)[0]}if(typeof(m)!=="object"||m===null||m===undefined){m=document.createElement("div");m.id=l;b.parentNode.appendChild(m);captionator.styleContainer(m,d[f].kind,b,false);m.style.display="none";d[f].autogen=true}if(String(b.getAttribute("aria-describedby")).indexOf(l)===-1){var j=b.hasAttribute("aria-describedby")?b.getAttribute("aria-describedby")+" ":"";b.setAttribute("aria-describedby",j+l)}if(k.length){for(n=0;n<k.length;n++){if(c>=k[n].timeIn&&c<=k[n].timeOut){i.push(k[n].html)}}h="<div class='captionator-title'>"+i.join("</div><div class='captionator-title'>")+"</div>";if(!i.length){if(m.innerHTML.length){m.innerHTML="";m.style.display="none"}}else{if(m.oldCaptions!==h){m.oldCaptions=h;m.innerHTML=h;m.style.display="block"}}}}else{if(g.enabled){captionator.fetchCaptions(g.src,function(o){g.captionData=o;g.subtitlesReady=true;g.enabled=true;captionator.rebuildCaptions(b)})}else{if(g.autogen){var e=document.getElementById(l);if(e){e.parentNode.removeChild(e)}g.autogen=false}}}})},styleContainer:function(h,c,b,g){var f=function(k,i){for(var j in i){if({}.hasOwnProperty.call(i,j)){k.style[j]=i[j]}}};var e=function(p){var k=window.getComputedStyle(p,null);var j=p;var m=p.offsetTop,n=p.offsetLeft;var l=p,i=0;var o=0;l=parseInt(k.getPropertyValue("width"),10);i=parseInt(k.getPropertyValue("height"),10);while(j=j.offsetParent){m+=j.offsetTop;n+=j.offsetLeft}if(p.hasAttribute("controls")){if(navigator.userAgent.toLowerCase().indexOf("chrome")!==-1){o=32}else{if(navigator.userAgent.toLowerCase().indexOf("firefox")!==-1){o=28}else{if(navigator.userAgent.toLowerCase().indexOf("ie9")!==-1){o=31}else{if(navigator.userAgent.toLowerCase().indexOf("safari")!==-1){o=25}}}}}return{left:n,top:m,width:l,height:i,controlHeight:o}};if(h instanceof HTMLElement&&b instanceof HTMLVideoElement){var d=e(b);var a=0;switch(c){case"caption":case"captions":case"subtitle":a=Math.ceil(d.height*0.15<30?30:d.height*0.15);f(h,{display:"block",position:"absolute",width:(d.width-40)+"px",height:a+"px",backgroundColor:"rgba(0,0,0,0.5)",left:d.left+"px",top:(d.top+d.height)-(a+d.controlHeight)+"px",fontSize:(a<=50?((a*0.7)/96)*72:((a*0.3)/96)*72)+"pt",lineHeight:(a<=50?(a/96)*72:((a/2)/96)*72)+"pt",color:"white",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"bold",textAlign:"center",paddingLeft:"20px",paddingRight:"20px",});break;case"textaudiodesc":break;case"karaoke":case"lyrics":a=(d.height*0.1<20?20:d.height*0.1);f(h,{display:"block",position:"absolute",width:(d.width-40)+"px",minHeight:a+"px",backgroundColor:"rgba(0,0,0,0.5)",left:d.left+"px",top:d.top+"px",fontSize:(a<=50?((a*0.5)/96)*72:((a*0.2)/96)*72)+"pt",lineHeight:(a<=50?(a/96)*72:((a/2)/96)*72)+"pt",color:"gold",fontStyle:"oblique",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"lighter",textAlign:"center",paddingLeft:"20px",paddingRight:"20px",});break;case"chapters":break;case"tickertext":break;case"toolbar":break;default:}h.className+=(h.className.length?" ":"")+"captionator-kind-"+c}},parseCaptions:function(a){if(a){var b=a.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(/\n\n/g).filter(function(c){if(c.match(/WEBVTT FILE/ig)){return false}else{return true}}).map(function(c){var j=c.split(/\n/g);var g,d,i,e,h,f;if(j[0].match(/^\s*\d+\s*$/ig)){j.shift(0)}for(f=0;f<j.length;f++){if(j[f].match(/^\d{2}:\d{2}:\d{2}[\.\,]\d+/)){h=j[f].split(/\s+/ig,4);g=parseFloat(((h[0].split(/[:\,\.]/ig)[0]*60*60)+(h[0].split(/[:\,\.]/ig)[1]*60)+parseInt(h[0].split(/[:\,\.]/ig)[2],10))+"."+parseInt(h[0].split(/[:\,\.]/ig)[3],10));d=parseFloat(((h[2].split(/[:\,\.]/ig)[0]*60*60)+(h[2].split(/[:\,\.]/ig)[1]*60)+parseInt(h[2].split(/[:\,\.]/ig)[2],10))+"."+parseInt(h[2].split(/[:\,\.]/ig)[3],10));j=j.slice(0,f).concat(j.slice(f+1));break}}e=j.join("\n");i=e.replace(/<[^>]+>/ig,"");return{timeIn:g,timeOut:d,text:i,html:e}});return b}else{throw new Error("Required parameter captionData not supplied.")}},fetchCaptions:function(c,d){var b,a=new XMLHttpRequest();a.open("GET",c,true);a.onreadystatechange=function(e){if(a.readyState==4){if(a.status==200){b=captionator.parseCaptions(a.responseText);if(d instanceof Function){d(b)}}else{}}};a.send(null)}};