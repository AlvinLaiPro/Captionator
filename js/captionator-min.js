/* 
	Captionator 0.2
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/

var captionator={createDOMException:function(d,h,b){try{document.querySelectorAll("div/[]")}catch(i){var a=function(c,f,e){this.code=c;this.message=f;this.name=e};a.prototype=i;return new a(d,h,b)}},captionify:function(d,h,b){var i=[],a=0;b=b instanceof Object?b:{};if(HTMLVideoElement){if(typeof document.createElement("video").addTrack==="function")return false}else return false;captionator.TextTrack=function(c,f,e,j){this.onload=function(){};this.onerror=function(){};this.oncuechange=function(){};
this.internalMode=0;this.cues=new captionator.TextTrackCueList(this);this.activeCues=new captionator.ActiveTextTrackCueList(this.cues);this.kind=c||"caption";this.label=f||"";this.language=e||"";this.src=j||"";this.readyState=0;this.getMode=function(){return this.internalMode};this.setMode=function(g){if([0,1,2].indexOf(g)!==-1){if(g!==this.internalMode){this.internalMode=g;this.readyState===0&&this.src.length>0&&g>0&&this.loadTrack(this.src);this.readyState===2&&captionator.rebuildCaptions(this.videoNode);
if(g===0||g===1){g="captionator-"+this.videoNode.id+"-"+this.kind+"-"+this.language;(g=document.getElementById(g))&&g.parentNode.removeChild(g)}}}else throw Error("Illegal mode value for track.");};if(Object.prototype.__defineGetter__){this.__defineGetter__("mode",this.getMode);this.__defineSetter__("mode",this.setMode)}else Object.defineProperty&&Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode});this.loadTrack=function(g,m){var n,l=new XMLHttpRequest;if(this.readyState===2)m instanceof
Function&&m(n);else{this.src=g;this.readyState=1;var k=this;l.open("GET",g,true);l.onreadystatechange=function(){if(l.readyState===4)if(l.status===200){n=captionator.parseCaptions(l.responseText);k.readyState=2;captionator.rebuildCaptions(k.videoNode);k.cues.loadCues(n);k.onload();m instanceof Function&&m.call(k,n)}else k.onerror()};l.send(null)}};this.generateTranscript=function(g){console.log("generating transcript",g);if(typeof g==="string")g=document.querySelectorAll(g)[0];if(typeof g==="object")if(this.readyState===
2)this.cues.forEach(function(m){g.innerHTML+="<p class='transcriptLine'>"+m.getCueAsSource()+"</p>"});else if(this.readyState===1)this.onload=function(){this.generateTranscript(g)};else this.loadTrack(this.src,function(){this.generateTranscript(g)});else return false};this.addCue=function(){};this.removeCue=function(){}};captionator.TextTrackCueList=function(c){this.track=c instanceof captionator.TextTrack?c:null;this.getCueById=function(f){return this.filter(function(e){return e.id===f})[0]};this.loadCues=
function(f){for(var e=0;e<f.length;e++){f[e].track=this.track;Array.prototype.push.call(this,f[e])}};this.toString=function(){return"[TextTrackCueList]"}};captionator.TextTrackCueList.prototype=[];captionator.ActiveTextTrackCueList=function(c){this.refreshCues=function(){var f=this;this.length=0;c.forEach(function(e){e.active&&f.push(e)})};this.toString=function(){return"[ActiveTextTrackCueList]"};this.refreshCues()};captionator.ActiveTextTrackCueList.prototype=new captionator.TextTrackCueList;captionator.TextTrackCue=
function(c,f,e,j,g,m,n){this.id=c;this.track=n instanceof captionator.TextTrack?n:null;this.startTime=parseFloat(f,10);this.endTime=parseFloat(e,10);this.text=typeof j==="string"?j:"";this.settings=typeof g==="string"?g:"";this.intSettings={};this.pauseOnExit=!!m;this.direction="horizontal";this.snapToLines=false;this.linePosition="auto";this.size=this.textPosition=0;this.alignment="";if(this.settings.length){var l=this.intSettings;g=g.split(/\s+/).filter(function(k){return k.length>0});g instanceof
Array&&g.forEach(function(k){var o={D:"verticalText",L:"linePosition",T:"textPosition",A:"textAlignment",S:"textSize"};k=k.split(":");if(o[k[0]])l[o[k[0]]]=k[1]})}this.getCueAsSource=function(){return this.text};this.getCueAsHTML=function(){var k=document.createDocumentFragment(),o=document.createElement("div");o.innerHTML=this.text;Array.prototype.forEach.call(o.childNodes,function(p){k.appendChild(p.cloneNode(true))});return k};this.isActive=function(){var k=0;if(this.track instanceof captionator.TextTrack)if(this.track.mode===
2&&this.track.readyState===2)try{k=this.track.videoNode.currentTime;if(this.startTime<=k&&this.endTime>=k)return true}catch(o){return false}return false};if(Object.prototype.__defineGetter__)this.__defineGetter__("active",this.isActive);else Object.defineProperty&&Object.defineProperty(this,"active",{get:this.isActive});this.onenter=function(){};this.onexit=function(){}};if(b.exportObjects){window.TextTrack=captionator.TextTrack;window.TextTrackCueList=captionator.TextTrackCueList;window.ActiveTextTrackCueList=
captionator.ActiveTextTrackCueList;window.TextTrackCue=captionator.TextTrackCue}[].slice.call(document.getElementsByTagName("video"),0).forEach(function(c){c.addTrack=function(f,e,j,g){e=typeof e==="string"?e:"";j=typeof j==="string"?j:"";if(!["subtitles","captions","descriptions","captions","metadata"].filter(function(m){return f===m?true:false}).length)throw captionator.createDOMException(12,"DOMException 12: SYNTAX_ERR: You must use a valid kind when creating a TimedTextTrack.","SYNTAX_ERR");if(e=
new captionator.TextTrack(f,e,j,g)){if(!(c.tracks instanceof Array))c.tracks=[];c.tracks.push(e);return e}else return false}});if(!d||d===false||d===undefined||d===null)i=[].slice.call(document.getElementsByTagName("video"),0);else if(d instanceof Array)for(a=0;a<d.length;a++)if(typeof d[a]==="string")i=i.concat([].slice.call(document.querySelectorAll(d[a]),0));else d[a].constructor===HTMLVideoElement&&i.push(d[a]);else if(typeof d==="string")i=[].slice.call(document.querySelectorAll(d),0);else d.constructor===
HTMLVideoElement&&i.push(d);if(i.length){for(a=0;a<i.length;a++)captionator.processVideoElement(i[a],h,b);return true}else return false},processVideoElement:function(d,h,b){var i=[];h||navigator.language.split("-");b=b instanceof Object?b:{};if(!d.captioned){d.captionatorOptions=b;d.className+=(d.className.length?" ":"")+"captioned";d.captioned=true;if(d.id.length===0){for(var a="";a.length<10;)a+=String.fromCharCode(65+Math.floor(Math.random()*26));d.id="captionator"+a}[].slice.call(d.querySelectorAll("track"),
0).forEach(function(c){var f=d.addTrack(c.getAttribute("kind"),c.getAttribute("label"),c.getAttribute("srclang").split("-")[0],c.getAttribute("src"));c.track=f;f.trackNode=c;f.videoNode=d;i.push(f);var e=false;if((f.kind==="subtitles"||f.kind==="captions")&&h===f.language&&b.enableCaptionsByDefault)i.filter(function(j){return(j.kind==="captions"||j.kind==="subtitles")&&h===j.language&&j.mode===2?true:false}).length||(e=true);if(f.kind==="chapters"&&h===f.language)i.filter(function(j){return j.kind===
"chapters"&&j.mode===2?true:false}).length||(e=true);if(f.kind==="descriptions"&&b.enableDescriptionsByDefault===true&&h===f.language)i.filter(function(j){return j.kind==="descriptions"&&j.mode===2?true:false}).length||(e=true);e===true&&i.forEach(function(j){if(j.trackNode.hasAttribute("default")&&j.mode===2)j.mode=1});if(c.hasAttribute("default"))i.filter(function(j){return j.trackNode.hasAttribute("default")&&j.trackNode!==c?true:false}).length||(e=true);if(e===true)f.mode=2});d.addEventListener("timeupdate",
function(c){c=c.target;try{c.tracks.forEach(function(e){e.activeCues.refreshCues()})}catch(f){}b.renderer instanceof Function?b.renderer.call(captionator,c):captionator.rebuildCaptions(c)},false)}return d},rebuildCaptions:function(d){var h="captionator-unset",b=null,i="";d.tracks.forEach(function(a){if(a.mode===2&&a.readyState===2){h="captionator-"+d.id+"-"+a.kind+"-"+a.language;if(b=a.containerObject?a.containerObject:document.getElementById(h))b.parentNode||document.body.appendChild(b);else{b=document.createElement("div");
b.id=h;document.body.appendChild(b);a.containerObject=b;b.setAttribute("aria-live","polite");b.setAttribute("aria-atomic","true");captionator.styleContainer(b,a.kind,a.videoNode)}if(String(d.getAttribute("aria-describedby")).indexOf(h)===-1){var c=d.hasAttribute("aria-describedby")?d.getAttribute("aria-describedby")+" ":"";d.setAttribute("aria-describedby",c+h)}i="";a.activeCues.forEach(function(f){i+='<div class="captionator-cue">'+f.getCueAsSource()+"</div>"});if(String(b.innerHTML)!==i)b.innerHTML=
i;b.style.display=i.length?"block":"none"}})},styleContainer:function(d,h,b){var i=function(c,f){for(var e in f)if({}.hasOwnProperty.call(f,e))c.style[e]=f[e]},a=function(c){var f=window.getComputedStyle(c,null),e=c,j=c.offsetTop,g=c.offsetLeft,m=c,n=0,l=0;m=parseInt(f.getPropertyValue("width"),10);for(n=parseInt(f.getPropertyValue("height"),10);e=e.offsetParent;){j+=e.offsetTop;g+=e.offsetLeft}if(c.hasAttribute("controls"))if(navigator.userAgent.toLowerCase().indexOf("chrome")!==-1)l=32;else if(navigator.userAgent.toLowerCase().indexOf("firefox")!==
-1)l=28;else if(navigator.userAgent.toLowerCase().indexOf("ie9")!==-1)l=31;else if(navigator.userAgent.toLowerCase().indexOf("safari")!==-1)l=25;return{left:g,top:j,width:m,height:n,controlHeight:l}};if(d instanceof HTMLElement&&b instanceof HTMLVideoElement){b=a(b);a=0;switch(h){case "caption":case "captions":case "subtitle":a=Math.ceil(b.height*0.15<30?30:b.height*0.15);i(d,{display:"block",position:"absolute",width:b.width-40+"px",height:a+"px",backgroundColor:"rgba(0,0,0,0.5)",left:b.left+"px",
top:b.top+b.height-(a+b.controlHeight)+"px",fontSize:(a<=50?a*0.7/96*72:a*0.3/96*72)+"pt",lineHeight:(a<=50?a/96*72:a/2/96*72)+"pt",color:"white",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"bold",textAlign:"center",paddingLeft:"20px",paddingRight:"20px"});break;case "karaoke":case "lyrics":a=b.height*0.1<20?20:b.height*0.1;i(d,{display:"block",position:"absolute",width:b.width-40+"px",minHeight:a+"px",backgroundColor:"rgba(0,0,0,0.5)",left:b.left+"px",top:b.top+
"px",fontSize:(a<=50?a*0.5/96*72:a*0.2/96*72)+"pt",lineHeight:(a<=50?a/96*72:a/2/96*72)+"pt",color:"gold",fontStyle:"oblique",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"lighter",textAlign:"center",paddingLeft:"20px",paddingRight:"20px"})}if(d.className.indexOf("captionator-kind")===-1)d.className+=(d.className.length?" ":"")+"captionator-kind-"+h}},parseCaptions:function(d){if(d)return d.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(/\n\n/g).filter(function(h){return h.match(/WEBVTT FILE/ig)?
false:true}).map(function(h){h=h.split(/\n/g);var b,i,a,c,f,e;if(h[0].match(/^\s*\d+\s*$/ig))e=String(h.shift(0).split(/\s+/).join(""));for(c=0;c<h.length;c++)if(h[c].match(/^\d{2}:\d{2}:\d{2}[\.\,]\d+/)){a=h[c].split(/\s+/ig);b=parseFloat(a[0].split(/[:\,\.]/ig)[0]*60*60+a[0].split(/[:\,\.]/ig)[1]*60+parseInt(a[0].split(/[:\,\.]/ig)[2],10)+"."+parseInt(a[0].split(/[:\,\.]/ig)[3],10));i=parseFloat(a[2].split(/[:\,\.]/ig)[0]*60*60+a[2].split(/[:\,\.]/ig)[1]*60+parseInt(a[2].split(/[:\,\.]/ig)[2],10)+
"."+parseInt(a[2].split(/[:\,\.]/ig)[3],10));if(a.length>=4)f=a.splice(3).join(" ");h=h.slice(0,c).concat(h.slice(c+1));break}h=h.join("\n");return new captionator.TextTrackCue(e,b,i,h,f,false,null)});else throw Error("Required parameter captionData not supplied.");}};